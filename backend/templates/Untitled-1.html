<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8"/>
  <title>PRESENCE SCANNER</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <link
    href="https://fonts.googleapis.com/css2?family=Exo+2:wght@400;600;700&display=swap"
    rel="stylesheet"
  />
  <style>
    body {
      margin: 0;
      padding: 0;
      display: flex;
      height: 100vh;
      font-family: 'Exo 2', sans-serif;
      overflow: hidden;
      background: url("/static/background.jpg") no-repeat center center fixed;
      background-size: cover;
    }
    .sidebar {
      position: fixed;
      top: 0;
      left: 0;
      height: 100%;
      width: 0;
      background-color: #d10056;
      overflow-x: hidden;
      transition: width 0.3s ease;
      padding-top: 60px;
      box-sizing: border-box;
      z-index: 1000;
    }
    .sidebar .closebtn {
      position: absolute;
      top: 10px;
      right: 15px;
      font-size: 30px;
      color: white;
      text-decoration: none;
    }
    .sidebar a {
      display: block;
      padding: 12px 20px;
      color: #fff;
      text-decoration: none;
      font-size: 18px;
      transition: background 0.2s;
    }
    .sidebar a:hover {
      background-color: #b8004a;
    }
    #main {
      flex: 1;
      margin-left: 0;
      transition: margin-left 0.3s ease;
      overflow-y: auto;
    }
    .openbtn {
      position: fixed;
      top: 15px;
      left: 15px;
      font-size: 20px;
      cursor: pointer;
      background-color: #d10056;
      color: white;
      padding: 10px 15px;
      border: none;
      border-radius: 4px;
      z-index: 1000;
    }
    .openbtn:hover {
      background-color: #b8004a;
    }
    .content1 {
      margin-left: 80px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    header {
      background: #d10056;
      color: white;
      padding: 15px;
      text-align: center;
      font-size: 22px;
      font-weight: bold;
      margin: 0;
    }
    main.content {
      padding: 20px;
    }
    .action-btn {
      background: #d10056;
      color: white;
      border: none;
      padding: 12px 18px;
      margin: 5px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 16px;
      text-decoration: none;
      display: inline-block;
    }
    .action-btn:hover {
      background: #7F00FF;
    }
    .logout-btn {
      background: #7F00FF;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 16px;
      margin-top: 10px;
    }
    .logout-btn:hover {
      background: #d10056;
    }
    #searchInput,
    #classFilter,
    #timezoneSelector {
      padding: 12px 20px;
      border: none;
      border-radius: 30px;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
      margin: 5px;
      width: 250px;
    }
    table {
      width: 100%;
      margin-top: 20px;
      border-collapse: collapse;
      background: white;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
    }
    th,
    td {
      padding: 10px;
      border: 1px solid #ddd;
      text-align: center;
    }
    th {
      background: #434f58;
      color: white;
    }
    #qr-reader {
      width: 300px;
      margin: 20px auto;
      display: none;
    }
    .table-container {
      overflow-x: auto;
      margin-top: 20px;
    }
  </style>
</head>
<body>
  <div id="mySidebar" class="sidebar">
    <a href="javascript:void(0)" class="closebtn" onclick="closeNav()">√ó</a>
    <a href="/index">Accueil</a>
    <a href="/etudiants">Liste des employ√©s</a>
  </div>

  <div id="main">
    <button class="openbtn" onclick="openNav()">‚ò∞ Menu</button>
    <div class="content1">
      <a href="/index">
        <img src="/static/Baobab.png" width="200px" alt="Baobab Banque"/>
      </a>
    </div>
    <header>üì∑ Application de Pr√©sence QR</header>
    <main class="content">
      <div style="text-align: center;">
        <button class="action-btn" onclick="startScanner()">üì∑ Scanner QR</button>
        <button class="action-btn" onclick="loadStudents()">üîÑ Rafra√Æchir</button>
        <button class="action-btn" onclick="resetPresence()">‚ôªÔ∏è R√©initialiser</button>
        <button class="action-btn" onclick="resetEntryExit()">üßπ R√©init Entr√©e/Sortie</button>
        <a href="/static/tena_izy.apk" download class="action-btn">‚¨áÔ∏è APK</a>
        <button onclick="logout()" class="logout-btn">üîì D√©connexion</button>
      </div>
      <div style="text-align: center; margin: 15px 0;">
        <input type="text" id="searchInput" placeholder="üîç Rechercher‚Ä¶"/>
        <select id="classFilter">
          <option value="">Toutes les postes</option>
        </select>
        <select id="timezoneSelector"></select>
      </div>
      <div id="qr-reader"></div>
      <div class="table-container">
        <table id="studentsTable">
          <thead>
            <tr>
              <th>MATRICULE</th>
              <th>NOM</th>
              <th>PRENOM(S)</th>
              <th>EMPLOI</th>
              <th>Pr√©sence</th>
              <th>Entr√©e</th>
              <th>Sortie</th>
              <th>HS (h:m)</th>
              <th>Montant HS</th>
              <th>Logs</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </main>
  </div>

  <script src="https://unpkg.com/html5-qrcode@2.3.7/html5-qrcode.min.js"></script>
  <script>
    const API_BASE = "https://baobab-attendance-1ad63c0e2cbb.herokuapp.com";
    const API_URL = `${API_BASE}/api/students`;
    const RESET_URL = `${API_BASE}/api/reset_presence`;
    const RESET_ENTRY_EXIT_URL = `${API_BASE}/api/reset_entry_exit`;
    const MARK_URL = `${API_BASE}/api/mark_presence`;

    let studentsData = [];
    let lastScan = "";
    let scanTimeout;

    function openNav() {
      document.getElementById("mySidebar").style.width = "200px";
      document.getElementById("main").style.marginLeft = "200px";
    }
    function closeNav() {
      document.getElementById("mySidebar").style.width = "0";
      document.getElementById("main").style.marginLeft = "0";
    }
    function logout() {
      window.location.href = "/login";
    }

    function populateTimezoneSelector() {
      const tzSelect = document.getElementById("timezoneSelector");
      for (let offset = -12; offset <= 12; offset++) {
        const label = offset >= 0 ? `GMT+${offset}` : `GMT${offset}`;
        const value =
          offset === 0
            ? "Etc/GMT"
            : offset > 0
            ? `Etc/GMT-${offset}`
            : `Etc/GMT+${-offset}`;
        const option = document.createElement("option");
        option.value = value;
        option.textContent = label;
        if (offset === 3) option.selected = true;
        tzSelect.appendChild(option);
      }
    }

    function getSelectedTimezone() {
      return document.getElementById("timezoneSelector").value || "Etc/GMT-3";
    }

    function formatToLocalTime(utcString) {
      if (!utcString) return "";
      try {
        const utcDate = new Date(utcString + "Z");
        return utcDate.toLocaleString("fr-FR", {
          timeZone: getSelectedTimezone(),
          hour12: false,
          timeZoneName: "short",
        });
      } catch (e) {
        console.warn("Erreur fuseau horaire :", e);
        return utcString;
      }
    }

    function populateClassFilter(data) {
      const sel = document.getElementById("classFilter");
      sel.innerHTML = '<option value="">Toutes les postes</option>';
      Array.from(new Set(data.map((s) => s.Emploi)))
        .sort()
        .forEach((cl) => {
          const opt = document.createElement("option");
          opt.value = cl;
          opt.textContent = cl;
          sel.appendChild(opt);
        });
    }

    
    /**
 * Transforme "YYYY-MM-DD HH:mm:ss" ‚Üí Date locale
 */
function parseLocal(dtString) {
  // On remplace l‚Äôespace par un T pour que JS le parse correctement
  return new Date(dtString.replace(" ", "T"));
}

/**
 * Calcule la dur√©e (en hHmM) entre entry et exit
 */
function computeDailyHS(entry, exit) {
  if (!entry || !exit) return "";
  const start = parseLocal(entry);
  const end   = parseLocal(exit);
  const diffMs  = Math.max(0, end.getTime() - start.getTime());
  const diffMin = Math.floor(diffMs / 1000 / 60);
  const h = Math.floor(diffMin / 60);
  const m = diffMin % 60;
  return `${h}H${m.toString().padStart(2, "0")}`;
}

/**
 * Calcule le montant Ar √† 10000 Ar/h pour daily HS
 */
function computeDailyAmount(entry, exit) {
  if (!entry || !exit) return "";
  const start = parseLocal(entry);
  const end   = parseLocal(exit);
  const diffMin = Math.floor((end.getTime() - start.getTime()) / 1000 / 60);
  const amount  = Math.floor((diffMin / 60) * 10000);
  return amount ? amount.toLocaleString("fr-FR") + " Ar" : "";
}

function renderTable(arr) {
  const tbody = document.querySelector("#studentsTable tbody");
  tbody.innerHTML = "";
  if (!arr.length) {
    tbody.innerHTML = "<tr><td colspan='10'>Aucun employ√© trouv√©</td></tr>";
    return;
  }
  arr.forEach(stu => {
    // ici on remplace stu.overtime par daily HS
    const dailyHS     = computeDailyHS(stu.entry_time, stu.exit_time);
    const dailyAmount = computeDailyAmount(stu.entry_time, stu.exit_time);

    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${stu.Matricule}</td>
      <td>${stu.Nom}</td>
      <td>${stu.Prenom}</td>
      <td>${stu.Emploi}</td>
      <td>${stu.Presence}</td>
      <td>${formatToLocalTime(stu.entry_time)}</td>
      <td>${formatToLocalTime(stu.exit_time)}</td>
      <td>${dailyHS}</td>
      <td>${dailyAmount}</td>
      <td>
        <button class="action-btn"
          onclick="window.location.href='/logs?id=${stu.Matricule}'">
          üìÑ Voir logs
        </button>
      </td>
    `;
    tbody.appendChild(tr);
  });
}


    function applyFilters() {
      const term = document
        .getElementById("searchInput")
        .value.trim()
        .toLowerCase();
      const cls = document.getElementById("classFilter").value;
      const filtered = studentsData.filter((s) => {
        const matchText =
          s.Matricule.toString().includes(term) ||
          s.Nom.toLowerCase().includes(term) ||
          s.Prenom.toLowerCase().includes(term);
        const matchCls = !cls || s.Emploi === cls;
        return matchText && matchCls;
      });
      renderTable(filtered);
    }

    async function loadStudents() {
      try {
        const tbody = document.querySelector("#studentsTable tbody");
        tbody.innerHTML = "<tr><td colspan='10'>Chargement‚Ä¶</td></tr>";
        const res = await fetch(API_URL);
        if (!res.ok) throw new Error(res.status);
        const json = await res.json();
        studentsData = json.data || [];
        populateClassFilter(studentsData);
        renderTable(studentsData);
      } catch (err) {
        alert("Erreur : " + err);
      }
    }

    async function resetPresence() {
        // 1) Invite l'admin √† saisir son mot de passe
        const pwd = prompt("üîê Entrez le mot de passe admin");
        if (!pwd) return;

        try {
          // 2) Appel prot√©g√© √† /api/reset_presence
          const res = await fetch("/api/reset_presence", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ password: pwd })
          });

          // 3) Gestion des erreurs HTTP
          if (!res.ok) {
            const err = await res.json();
            return alert("‚ùå " + (err.detail || err.message));
          }

          // 4) Tout s'est bien pass√©
          const json = await res.json();
          alert("‚úÖ " + json.message);
          loadStudents();
        }
        catch (e) {
          console.error(e);
          alert("‚ùå Erreur r√©seau : " + e.message);
        }
      }

    async function resetEntryExit() {
      if (!confirm("R√©initialiser toutes les entr√©es et sorties ?")) return;
      try {
        const res = await fetch(RESET_ENTRY_EXIT_URL, { method: "POST" });
        const json = await res.json();
        if (json.status === "ok") {
          alert("‚úÖ " + json.message);
          loadStudents();
        } else {
          alert("‚ùå " + (json.message || "Erreur inconnue"));
        }
      } catch (err) {
        console.error(err);
        alert("Erreur r√©seau : " + err.message);
      }
    }

    async function startScanner() {
      const reader = document.getElementById("qr-reader");
      reader.innerHTML = "";
      reader.style.display = "block";

      const qr = new Html5Qrcode("qr-reader");
      await qr.start(
        { facingMode: "environment" },
        { fps: 10, qrbox: 250 },
        (decodedText) => {
          if (decodedText === lastScan) return;
          lastScan = decodedText;
          clearTimeout(scanTimeout);
          scanTimeout = setTimeout(() => {
            qr.stop().then(() => {
              reader.style.display = "none";
              handleScan(decodedText);
            });
          }, 2000);
        },
        (err) => console.warn("Erreur scan :", err)
      );
    }

    async function handleScan(decodedText) {
      const parts = decodedText.split(";");
      const p = parts.find((p) =>
        p.trim().toLowerCase().startsWith("matricule:")
      );
      if (!p) return alert("‚ùå QR invalide : Matricule non trouv√©");
      const studentId = p.split(":")[1]?.trim();
      if (!studentId) {
        return alert("‚ùå Matricule vide ou non d√©tect√©");
      }

      try {
        const res = await fetch(`${MARK_URL}/${studentId}`, { method: "POST" });
        const json = await res.json();

        if (json.status === "ok") {
          alert(`‚úÖ 
Entr√©e : ${formatToLocalTime(json.entry_time)}
Sortie  : ${formatToLocalTime(json.exit_time)}`);
          loadStudents();
        } else {
          alert("‚ùå Erreur API : " + (json.message || "R√©ponse inconnue"));
        }
      } catch (err) {
        alert("‚ùå Erreur r√©seau : " + err.message);
      }
    }

    window.addEventListener("DOMContentLoaded", () => {
      populateTimezoneSelector();
      loadStudents();
      document
        .getElementById("searchInput")
        .addEventListener("input", applyFilters);
      document
        .getElementById("classFilter")
        .addEventListener("change", applyFilters);
      document
        .getElementById("timezoneSelector")
        .addEventListener("change", () => renderTable(studentsData));
    });
  </script>
</body>
</html>
```